try:
	import toml
except:
	print("\n**************************************\nPlease install toml to use Armature.py\n> pip install toml\n**************************************\n")
import sys
from pathlib import Path

#parsed as dictionary data from the .arms/toml file
arms = None

shapes = {
	'box': 0,
	'sphere': 0
}

def get_shape_by_name(target_name):
	for shape in shapes:
		if shape in arms:
			for item in arms[shape]:
				if item['name'] == target_name:
					return item

def create_joints():
	result = ""

	if 'joint' in arms:
		for joint in arms['joint']:
			if joint['type'] == 'ball':
				#get parent and child
				parent = get_shape_by_name(joint['parent'])
				child = get_shape_by_name(joint['child'])
				#get their positions
				parent_position = parent['position']
				child_position = child['position']
				#set ball joint axis to middle of parent and child
				axis_x = (parent_position[0] + child_position[0])/2
				axis_y = (parent_position[1] + child_position[1])/2
				axis_z = (parent_position[2] + child_position[2])/2

				new_joint = f"""//Generated by Armature
	dJointID {joint['name']} = dJointCreateBall(world, 0);
	dJointAttach({joint['name']}, body_{parent['name']}, body_{child['name']});
	dJointSetBallAnchor({joint['name']}, {axis_x}, {axis_y}, {axis_z});
	"""
				result = f'{result}{new_joint}'


	return result

def body_variables():
	result = ""

	#spheres
	if 'sphere' in arms:
		for body in arms['sphere']:
			new_body = f"""//Gernerated by Armature
static dBodyID body_{body['name']};
static dGeomID geom_{body['name']};
"""
			result = f'{result}{new_body}'

	#boxes
	if 'box' in arms:
		for body in arms['box']:

			sides = body['sides']

			new_body = f"""//Gernerated by Armature
static dBodyID body_{body['name']};
static dGeomID geom_{body['name']};
const float sides_{body['name']}[3] = {{ {sides[0]}, {sides[1]}, {sides[2]} }};
"""
			result = f'{result}{new_body}'

	return result

def reset_bodies():
	result = ""
	
	#spheres
	if 'sphere' in arms:
		for body in arms['sphere']:
			name = body['name']
			position = body['position']

			new_code = f"""
	//Generated by Armature
	float sx{name} = {position[0]}f, sy{name} = {position[1]}f, sz{name} = {position[2]}f;
	dQuaternion q{name};
	dQSetIdentity(q{name});
	dBodySetPosition(body_{name}, sx{name}, sy{name}, sz{name});
	dBodySetQuaternion(body_{name}, q{name});
	dBodySetLinearVel(body_{name}, 0, 0, 0);
	dBodySetAngularVel(body_{name}, 0, 0, 0);
	"""

			result = f'{result}{new_code}'

	#boxes
	if 'box' in arms:
		for body in arms['box']:
			name = body['name']
			position = body['position']

			new_code = f"""
	//Generated by Armature
	dBodySetPosition(body_{name}, {position[0]}, {position[1]}, {position[2]});
	dBodySetLinearVel(body_{name}, 0, 0, 0);
	dBodySetAngularVel(body_{name}, 0, 0, 0);
"""

			result = f'{result}{new_code}'
	
	return result

def draw_bodies():
	result = ""

	#spheres
	if 'sphere' in arms:
		for body in arms['sphere']:
			name = body['name']
			color = body['color']
			radius = body['radius']

			new_code = f"""
	//Generated by Armature
	dsSetColor({color[0]}, {color[1]}, {color[2]});
	const dReal *SPos_{name} = dBodyGetPosition(body_{name});
	const dReal *SRot_{name} = dBodyGetRotation(body_{name});
	float spos_{name}[3] = {{ SPos_{name}[0], SPos_{name}[1], SPos_{name}[2] }};
	float srot_{name}[12] = {{ SRot_{name}[0], SRot_{name}[1], SRot_{name}[2], SRot_{name}[3], SRot_{name}[4], SRot_{name}[5], SRot_{name}[6], SRot_{name}[7], SRot_{name}[8], SRot_{name}[9], SRot_{name}[10], SRot_{name}[11] }};
	dsDrawSphere
	(
		spos_{name},
		srot_{name},
		{radius}
	);
	"""

			result = f'{result}{new_code}'
	
	#boxes
	if 'box' in arms:
		for body in arms['box']:
			name = body['name']
			color = body['color']
			sides = body['sides']

			new_code = f"""
	//Generated by Armature
	dsSetColor({color[0]}, {color[1]}, {color[2]});
	dsDrawBox(dBodyGetPosition(body_{name}),
		dBodyGetRotation(body_{name}), sides_{name});
"""

			result = f'{result}{new_code}'

	

	return result

def create_shapes():
	result = ""

	#spheres
	if 'sphere' in arms:
		for body in arms['sphere']:
			name = body['name']
			colors = body['color']
			radius = body['radius']

			new_code = f"""
	//Generated by Armature
	//Create Sphere_{name}
	body_{name} = dBodyCreate(world);
	dMassSetSphere(&m, 1, {radius});
	dBodySetMass(body_{name}, &m);
	geom_{name} = dCreateSphere(0, {radius});
	dGeomSetBody(geom_{name}, body_{name});
	dSpaceAdd(space, geom_{name});
	"""
			result = f'{result}{new_code}'

	#boxes
	if 'box' in arms:
		for body in arms['box']:
			name = body['name']
			sides = body['sides']
			position = body['position']

			new_code = f"""
	//Generated by Armature
	//Create Box_{name}
	body_{name} = dBodyCreate(world);
	geom_{name} = dCreateBox(0, {sides[0]}, {sides[1]}, {sides[2]});
	dGeomSetBody(geom_{name}, body_{name});
	m.setBox(1, 1,1,1);
	dBodySetMass(body_{name}, &m);
	dBodySetPosition(body_{name}, {position[0]}, {position[1]}, {position[2]});
	dSpaceAdd(space, geom_{name});
"""

			result = f'{result}{new_code}'

	return result

def main():

	args = sys.argv

	file_to_parse = None
	where_to_save = None

	if len(args) == 1:
		print("Please give one argument as the ARMS file to parse, and a second, optional, argument as the save location.\n\
		i.e. >python Armature.py my/super/cool/file.arms where/i/want/to/save")
		quit()

	if len(args) > 1:
		file_to_parse = Path(args[1])

	if len(args) > 2:
		where_to_save = Path(f"{args[2]}/{file_to_parse.stem}_ODE.cpp")
	else:
		where_to_save = Path(f"./{file_to_parse.stem}_ODE.cpp")

	global arms
	arms = toml.loads(file_to_parse.read_text())

	template_path = Path("templates/basic_template.txt")
	template_string = template_path.read_text()

	if type(arms) is dict:
		where_to_save.write_text(template_string.format(
		create_shapes = create_shapes(), 
		draw_bodies = draw_bodies(), 
		reset_bodies = reset_bodies(), 
		body_variables = body_variables(),
		create_joints = create_joints())
		)

main()